{% load static %}
<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-950">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qwir Blingz – {{ detail.title }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            grotesk: ['Space Grotesk', 'sans-serif'],
          },
          colors: {
            night: '#07101B',
            starlight: '#FFFEF1',
            candy: '#29D9C0',
            plum: '#7C3AED',
          },
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Space Grotesk', sans-serif; }
    .scrollbar-hidden::-webkit-scrollbar { display: none; }
    .scrollbar-hidden { scrollbar-width: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-night via-purple-950 to-slate-900 text-starlight">
  <header class="border-b border-white/10 bg-night/60 backdrop-blur">
    <div class="mx-auto flex max-w-7xl flex-col gap-4 px-6 py-6 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <a href="{% url 'frontend:feed' %}" class="text-sm text-candy underline decoration-dotted">← Retour au flux</a>
        <h1 class="mt-2 text-3xl font-semibold text-amber-200">{{ detail.title }}</h1>
        {% if detail.description %}
          <p class="text-sm text-slate-300">{{ detail.description }}</p>
        {% endif %}
        {% if detail.fallback %}
          <p class="mt-2 text-xs uppercase tracking-wide text-rose-300">Mode offline – données de secours.</p>
        {% endif %}
      </div>
      <div class="flex items-center gap-3">
        <a href="#sections" class="rounded-full border border-white/20 px-3 py-1 text-xs uppercase tracking-wide text-white/80 transition hover:border-candy hover:text-candy">Explorer les sections</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl space-y-12 px-6 py-10">
    {% if detail.feature %}
      <section class="grid gap-6 rounded-3xl border border-white/10 bg-night/70 p-8 shadow-2xl shadow-purple-900/40 backdrop-blur md:grid-cols-[2fr_3fr]">
        <div class="space-y-4">
          {% if detail.feature.poster_url %}
            <img src="{{ detail.feature.poster_url }}" alt="Affiche de {{ detail.feature.title }}" class="w-full max-w-sm rounded-2xl object-cover shadow-lg" />
          {% endif %}
        </div>
        <div class="space-y-4">
          <div>
            <p class="text-sm uppercase tracking-wide text-candy">Coup de projecteur</p>
            <h2 class="text-3xl font-semibold text-amber-200">{{ detail.feature.title }}</h2>
            {% if detail.feature.original_title %}
              <p class="text-sm italic text-slate-300">{{ detail.feature.original_title }}</p>
            {% endif %}
            {% if detail.feature.genres %}
              <p class="text-sm text-slate-300">{{ detail.feature.genres|join:" • " }}</p>
            {% endif %}
            {% if detail.feature.rating %}
              <p class="text-sm text-amber-200">★ {{ detail.feature.rating|floatformat:1 }}{% if detail.feature.vote_count %} ({{ detail.feature.vote_count }}){% endif %}</p>
            {% endif %}
          </div>
          <p class="text-sm text-slate-100">{{ detail.feature.overview }}</p>
          {% if detail.feature.directors %}
            <p class="text-sm text-slate-200"><span class="font-semibold text-candy">Réalisation :</span> {{ detail.feature.directors|join:", " }}</p>
          {% endif %}
          {% if detail.feature.cast %}
            <p class="text-sm text-slate-200"><span class="font-semibold text-candy">Avec :</span> {{ detail.feature.cast|join:", " }}</p>
          {% endif %}
          <button type="button" class="rounded-full border border-amber-300 px-4 py-2 text-sm font-semibold text-amber-200 transition hover:bg-amber-200 hover:text-night" data-modal-trigger data-theme="{{ detail.theme }}" data-index="feature">
            Ouvrir la fiche détaillée
          </button>
        </div>
      </section>
    {% endif %}

    <section id="sections" class="space-y-10">
      {% for section in detail.sections %}
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-semibold text-amber-200">{{ section.title }}</h3>
            <p class="text-sm text-slate-400">{{ section.items|length }} titres</p>
          </div>
          <div class="grid gap-6 md:grid-cols-3 lg:grid-cols-4">
            {% for item in section.items %}
              <button type="button" class="relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/70 text-left shadow-xl transition hover:-translate-y-1 hover:shadow-purple-900/40" data-modal-trigger data-theme="{{ detail.theme }}" data-index="{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}">
                {% if item.poster_url %}
                  <img src="{{ item.poster_url }}" alt="Affiche de {{ item.title }}" class="h-72 w-full object-cover" />
                {% else %}
                  <div class="flex h-72 items-center justify-center bg-night/80 text-sm text-slate-400">Affiche manquante</div>
                {% endif %}
                <div class="space-y-2 p-4">
                  <h4 class="text-lg font-semibold text-amber-100">{{ item.title }}</h4>
                  {% if item.release_year or item.genres %}
                    <p class="text-xs text-slate-300">{{ item.release_year }}{% if item.release_year and item.genres %} • {% endif %}{{ item.genres|join:", " }}</p>
                  {% endif %}
                  {% if item.rating %}
                    <p class="text-xs text-amber-200">★ {{ item.rating|floatformat:1 }}{% if item.vote_count %} ({{ item.vote_count }}){% endif %}</p>
                  {% endif %}
                  <p class="line-clamp-3 text-xs text-slate-200">{{ item.overview }}</p>
                </div>
              </button>
            {% empty %}
              <div class="rounded-xl border border-white/10 bg-night/70 p-6 text-sm text-slate-300">Pas encore de titres dans cette section.</div>
            {% endfor %}
          </div>
        </div>
      {% empty %}
        <p class="text-sm text-slate-300">Pas encore de contenus disponibles pour ce thème.</p>
      {% endfor %}
    </section>
  </main>

  {{ detail|json_script:"theme-detail-data" }}

  <div id="detail-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-night/80 p-6 backdrop-blur" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="relative h-[90vh] w-full max-w-4xl overflow-y-auto rounded-3xl border border-white/10 bg-night/90 p-6 shadow-2xl shadow-purple-900/60">
      <button type="button" class="absolute right-4 top-4 rounded-full border border-white/30 px-3 py-1 text-sm text-white transition hover:bg-white hover:text-night" data-modal-close>
        Fermer
      </button>
      <div data-modal-content class="space-y-6"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const detailData = JSON.parse(document.getElementById('theme-detail-data').textContent);
      const itemLookup = new Map();

      detailData.sections.forEach((section, sectionIdx) => {
        section.items.forEach((item, itemIdx) => {
          itemLookup.set(`${sectionIdx}-${itemIdx}`, item);
        });
      });

      if (detailData.feature) {
        itemLookup.set('feature', detailData.feature);
      }

      const modal = document.getElementById('detail-modal');
      const modalContent = modal ? modal.querySelector('[data-modal-content]') : null;

      const renderModal = (item) => {
        const poster = item.poster_url
          ? `<img src="${item.poster_url}" alt="Affiche de ${item.title}" class="h-80 w-full max-w-xs rounded-2xl object-cover" />`
          : '';
        const directors = (item.directors || []).length ? `<p class="text-sm text-slate-200"><span class="font-semibold text-candy">Réalisation :</span> ${(item.directors || []).join(', ')}</p>` : '';
        const cast = (item.cast || []).length ? `<p class="text-sm text-slate-200"><span class="font-semibold text-candy">Avec :</span> ${(item.cast || []).join(', ')}</p>` : '';
        const genres = (item.genres || []).length ? `<p class="text-sm text-slate-300">${item.genres.join(' • ')}</p>` : '';
        const runtime = item.runtime ? `<p class="text-sm text-slate-300">Durée : ${item.runtime} min</p>` : '';
        const rating = item.rating ? `<p class="text-sm text-amber-200">★ ${Number(item.rating).toFixed(1)}${item.vote_count ? ` (${item.vote_count})` : ''}</p>` : '';
        const similar = (item.similar || []).length
          ? `<ul class="grid gap-2 text-sm text-slate-100">${item.similar.slice(0, 8).map((film) => `<li class="flex items-center gap-2"><span class="inline-flex h-2 w-2 rounded-full bg-candy"></span> ${film.title}${film.release_year ? ` (${film.release_year})` : ''}</li>`).join('')}</ul>`
          : '<p class="text-sm text-slate-300">Pas encore de suggestions similaires.</p>';
        const providers = (item.watch && item.watch.providers && item.watch.providers.length)
          ? `<ul class="flex flex-wrap gap-2">${item.watch.providers.map((provider) => `<li class="rounded-full border border-white/15 px-3 py-1 text-xs text-white/80">${provider.name} — ${provider.type}</li>`).join('')}</ul>`
          : '<p class="text-sm text-slate-300">Aucune plateforme renseignée pour le moment.</p>';
        const providerLink = (item.watch && item.watch.link)
          ? `<a href="${item.watch.link}" target="_blank" rel="noopener" class="text-sm text-candy underline">Consulter sur TMDb</a>`
          : '';

        return `
          <article class="space-y-6">
            <header class="flex flex-col gap-6 md:flex-row">
              ${poster}
              <div class="space-y-3">
                <h2 class="text-3xl font-semibold text-amber-100">${item.title || 'Titre à confirmer'}</h2>
                ${item.original_title ? `<p class="text-sm text-slate-300 italic">${item.original_title}</p>` : ''}
                ${genres}
                ${runtime}
                ${rating}
                <p class="text-sm text-slate-200">${item.overview || 'Résumé à venir.'}</p>
                ${directors}
                ${cast}
              </div>
            </header>
            <section class="space-y-3">
              <h3 class="text-lg font-semibold text-amber-200">Films similaires</h3>
              ${similar}
            </section>
            <section class="space-y-3">
              <h3 class="text-lg font-semibold text-amber-200">Où regarder</h3>
              ${providers}
              ${providerLink}
            </section>
          </article>
        `;
      };

      const openModal = (item) => {
        if (!modal || !modalContent) return;
        modalContent.innerHTML = renderModal(item);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('overflow-hidden');
      };

      const closeModal = () => {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('overflow-hidden');
      };

      if (modal) {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });
        const closeBtn = modal.querySelector('[data-modal-close]');
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeModal();
          }
        });
      }

      const findItemByKey = (key) => itemLookup.get(key) || null;

      document.body.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-modal-trigger]');
        if (!trigger) return;
        const key = trigger.getAttribute('data-index');
        const item = findItemByKey(key);
        if (item) {
          openModal(item);
        }
      });
    });
  </script>
</body>
</html>
